---
layout: article
title: 【技术类】Python绘制地图——基于matplotlib
tags: 技术类
show_tags: true
show_title: true
Show_date : true
articles:
excerpt_type: html
key : !!str 'python_map_2025_01_07'
Comment: true
---

一般通用教程是使用geopandas库，但不知为何装不了这个库，因此改用matplotlib。需要实现的功能是：

1. 分地级市的边界线。包含南海群岛，并使用子图来表示（另一种方法是九段线或十段线）。
2. 用由浅到深的色带表示数据大小。
3. 在有数据的城市标注城市名称。（后舍弃）

# 准备

需要另外下载的数据：

GeoJson文件，推荐两个网址：[市级粒度](https://datav.aliyun.com/portal/school/atlas/area_selector)；[另一个网站]( https://geojson.cn/data)提供了子图形式的南海群岛。两个网站都有用到。

# 过程

## 1. 调用api

获得南海群岛的边界数据。第一个网址可以直接下载。

````
##下载南海诸岛的边界
import requests
import json

url = f" https://geojson.cn/api/china/china.json"
# 发起请求
response = requests.get(url)

# 检查请求是否成功
if response.status_code == 200:
    # 解析 JSON 数据
    geojson_data = response.json()

    # 保存为本地文件
    with open(f"data.json", "w", encoding="utf-8") as f:
        json.dump(geojson_data, f, ensure_ascii=False, indent=4)
    
    print(f"成功下载并保存 data 到本地。")
else:
    print(f"请求失败，状态码：{response.status_code}")
````

## 2. 加入直辖市和南海群岛的json数据

第一个网址提供的地级市粒度的边界数据中，直辖市实际是区的粒度，比如“东城区”，因此需要找到省级数据中的直辖市json数据，合并到原边界数据里（不需要删掉原本的）。此外，要把第二个网址中的南海群岛边界加入。

每个地级市是用字典格式传入，数据类型如下：

```
municipalities_data = [
    {
        "type": "Feature",
        "properties": {
            "adcode": 110000,
            "name": "北京市",
            "center": [116.405285, 39.904989],
            "centroid":[116.41995,40.18994],
            "level": "province"
        },
        "geometry": {
            "type": "MultiPolygon",
            "coordinates": [[[[117.348611,40.581141],[117.389879,40.561593],[117.429915,40.576141],[117.412669,40.605226],[117.467487,40.649738],[117.467487,40.649738],[117.501364,40.636569],[117.514914,40.660181],[117.493973,40.675161],[117.408973,40.686961],[117.342451,40.673799],[117.319662,40.657911],[117.278394,40.664267],[117.208177,40.694675],[117.117018,40.70012],[117.11209,40.707379],[117.012308,40.693767],[116.964881,40.709647],[116.926692,40.745022],[116.924229,40.773581],[116.848468,40.839264],[116.81336,40.848319],[116.759773,40.889954],[116.713577,40.909858],[116.722201,40.927495],[116.677853,40.970888],[116.698795,41.021477],[116.688324,41.044501],[116.647672,41.059394],[116.615643,41.053076],[116.623034,41.021026],[116.598397,40.974503],[116.5676,40.992574],[116.519557,40.98128],[116.519557,40.98128],[116.455499,40.980828],[116.447492,40.953715],[116.477057,40.899907],[116.398216,40.90624],[116.370499,40.94377],[116.339702,40.929303],[116.334159,40.90443],[116.438253,40.81934],[116.46597,40.774487],[116.453651,40.765876],[116.316912,40.772221],[116.311369,40.754996],[116.273181,40.762703],[116.247311,40.791707],[116.22021,40.744115],[116.204812,40.740035],[116.171551,40.695582],[116.162928,40.662451],[116.133979,40.666536],[116.09887,40.630665],[116.005247,40.583868],[115.982457,40.578868],[115.971986,40.6025],[115.907929,40.617493],[115.885139,40.595229],[115.827857,40.587504],[115.819849,40.55932],[115.784741,40.55841],[115.755176,40.540221],[115.736082,40.503372],[115.781045,40.49336],[115.771806,40.443734],[115.864197,40.359422],[115.917784,40.354405],[115.95166,40.281852],[115.968907,40.264045],[115.89869,40.234354],[115.870356,40.185909],[115.855574,40.188652],[115.847567,40.147036],[115.806299,40.15344],[115.773654,40.176307],[115.75456,40.145663],[115.75456,40.145663],[115.599959,40.119583],[115.59072,40.096239],[115.527278,40.076092],[115.485394,40.040364],[115.454597,40.029825],[115.450286,39.992697],[115.428728,39.984443],[115.426264,39.950502],[115.481083,39.935819],[115.522967,39.899099],[115.515575,39.892212],[115.515575,39.892212],[115.526046,39.87568],[115.514344,39.837549],[115.567314,39.816407],[115.552532,39.794799],[115.50572,39.784222],[115.483547,39.798477],[115.483547,39.798477],[115.443511,39.785601],[115.439815,39.752022],[115.486626,39.741899],[115.491554,39.670074],[115.478619,39.650723],[115.478619,39.650723],[115.522351,39.640124],[115.518039,39.597252],[115.545756,39.618922],[115.587024,39.589873],[115.633836,39.599557],[115.633836,39.599557],[115.667712,39.615234],[115.698509,39.577881],[115.698509,39.577881],[115.699125,39.570039],[115.699125,39.570039],[115.716988,39.56035],[115.716988,39.56035],[115.718835,39.553891],[115.718835,39.553891],[115.720683,39.551122],[115.720683,39.551122],[115.722531,39.5442],[115.721299,39.543738],[115.722531,39.5442],[115.722531,39.543738],[115.721299,39.543738],[115.722531,39.543738],[115.724995,39.5442],[115.724995,39.5442],[115.738545,39.540046],[115.738545,39.539585],[115.738545,39.540046],[115.738545,39.539585],[115.752712,39.515581],[115.806299,39.510041],[115.806299,39.510041],[115.821081,39.522968],[115.821081,39.522968],[115.828473,39.541431],[115.867893,39.546507],[115.867893,39.546507],[115.91532,39.582955],[115.91532,39.582955],[115.910393,39.600479],[115.910393,39.600479],[115.957204,39.560812],[115.978146,39.595868],[115.995392,39.576958],[116.026189,39.587567],[116.036044,39.571884],[116.09887,39.575113],[116.130283,39.567732],[116.151841,39.583416],[116.198652,39.589412],[116.240536,39.564041],[116.257782,39.500344],[116.307057,39.488337],[116.337854,39.455536],[116.361876,39.455074],[116.361876,39.455074],[116.434557,39.442597],[116.454883,39.453226],[116.444412,39.482332],[116.411767,39.482794],[116.401912,39.528046],[116.443796,39.510041],[116.437637,39.526661],[116.478289,39.535431],[116.473361,39.552968],[116.50847,39.551122],[116.524484,39.596329],[116.592237,39.621227],[116.592237,39.621227],[116.620571,39.601863],[116.664918,39.605552],[116.723432,39.59264],[116.724048,39.59264],[116.723432,39.59264],[116.724048,39.59264],[116.726512,39.595407],[116.726512,39.595407],[116.709266,39.618],[116.748686,39.619844],[116.79057,39.595868],[116.812128,39.615695],[116.8497,39.66777],[116.906366,39.677444],[116.90575,39.688037],[116.889736,39.687576],[116.887272,39.72533],[116.916837,39.731314],[116.902055,39.763523],[116.949482,39.778703],[116.918069,39.84628],[116.907598,39.832494],[116.865714,39.843982],[116.812128,39.889916],[116.78441,39.891294],[116.782563,39.947749],[116.757925,39.967934],[116.781331,40.034866],[116.820135,40.02845],[116.831222,40.051359],[116.867562,40.041739],[116.927924,40.055024],[116.945171,40.04128],[117.025243,40.030283],[117.051728,40.059605],[117.105315,40.074261],[117.105315,40.074261],[117.140423,40.064185],[117.159517,40.077008],[117.204481,40.069681],[117.210024,40.082045],[117.224191,40.094865],[117.224191,40.094865],[117.254988,40.114548],[117.254988,40.114548],[117.254988,40.114548],[117.274082,40.105852],[117.307343,40.136971],[117.349227,40.136513],[117.367089,40.172649],[117.367089,40.173106],[117.367089,40.173106],[117.367089,40.172649],[117.383719,40.188195],[117.389879,40.227958],[117.351075,40.229786],[117.331365,40.289613],[117.295024,40.2782],[117.271618,40.325211],[117.271618,40.325211],[117.243285,40.369453],[117.226039,40.368997],[117.234046,40.417312],[117.263611,40.442367],[117.208793,40.501552],[117.262995,40.512927],[117.247597,40.539766],[117.269771,40.560684],[117.348611,40.581141],[117.348611,40.581141]]]]
        }
    },]
```

修改原json文件的代码（也可以手动修改文件）：

```
import json

# 读取原始 GeoJSON 文件（地级市的边界）
with open('地级市层级地理边界.json', 'r', encoding='utf-8') as f:
    boundary_data = json.load(f)

# 假设这些数据是直辖市的边界（多个直辖市，类似您给出的格式）
# 示例：您可以把这些数据作为字典格式传入
municipalities_data = [......]

# 将直辖市的边界数据添加到原始的 GeoJSON 数据的 features 列表中
boundary_data['features'].extend(municipalities_data)

# 保存更新后的 GeoJSON 文件
with open('updated_geojson_with_municipalities_nanhai.json', 'w', encoding='utf-8') as f:
    json.dump(boundary_data, f, ensure_ascii=False, indent=4)
```

## 3. 绘制地图

需要注意的2个细节：

1. 修改中文字体，否则标题中显示不出来。字体文件是以`ttc`结尾的文件，macos可以在“字体册-右键【在访达中显示】“找到对应的字体文件，然后复制到目录下。
2. 确定你的数据中的地级市名称和json文件中的一致，比如我的数据中不带“市”等字样，因此在读取json时要去掉其中的“市”等。

```
import json
import matplotlib.pyplot as plt
from matplotlib.patches import Polygon
from matplotlib.collections import PatchCollection
import pandas as pd
import matplotlib.colors as mcolors
import numpy as np
from matplotlib import font_manager
from shapely.geometry import shape

# 设置字体为 STHeiti Medium.ttc
font_path = 'STHeiti Medium.ttc'  # 请替换为你实际的字体路径
font_prop = font_manager.FontProperties(fname=font_path)
plt.rcParams['font.family'] = font_prop.get_name()  # 设置字体
plt.rcParams['axes.unicode_minus'] = False  # 显示负号

# 读取边界 JSON 文件
json_path = "updated_geojson_with_municipalities_nanhai.json"  # 替换为你的 JSON 文件路径
with open(json_path, 'r', encoding='utf-8') as f:
    boundary_data = json.load(f)

# 读取数据
city_data = pd.read_excel("xxx.xlsx")  # 替换为你的 Excel 文件路径
city_data.rename(columns={"数据": "park_count"}, inplace=True)

# 去掉城市名称中的后缀（如“市”、“地区”）
city_data['city'] = city_data['city'].str.replace("市|地区|盟|自治州", "", regex=True)
city_to_count = dict(zip(city_data['city'], city_data['park_count']))

# 设置绘图
fig, ax = plt.subplots(figsize=(15, 10))
patches = []
colors = []

# 遍历 JSON 文件中的边界数据
for feature in boundary_data['features']:
    # 获取城市名称，并去掉后缀
    city_name = feature['properties']['name'].replace("市", "").replace("地区", "").replace("自治州", "")
    park_count = city_to_count.get(city_name, 0)  # 获取城市的产业园数量，默认为 0

    # 处理几何数据
    coordinates = feature['geometry']['coordinates']
    if feature['geometry']['type'] == "Polygon":
        polygons = [coordinates]
    elif feature['geometry']['type'] == "MultiPolygon":
        polygons = coordinates
    else:
        continue

    # 绘制多边形
    for polygon in polygons:
        poly = Polygon(polygon[0], closed=True)
        patches.append(poly)
        colors.append(park_count)

    # 获取城市的几何中心（centroid）
    geom = shape(feature['geometry'])
    city_center = geom.centroid  # 使用几何中心作为城市名称的位置

    # 只有数据数量不为0时才绘制城市名称
    if park_count > 0:
        print(f"城市: {city_name}, 数量: {park_count}")
        # 动态设置字体大小，数字越大字体越大
        font_size = 10 + (park_count // 10)  # 基础字体大小 + 每增加10个单位字体增大
        font_size = min(font_size, 14)  # 设置最大字体大小为 14
        ax.text(city_center.x, city_center.y, city_name, fontsize=font_size, ha='center', va='center', fontproperties=font_prop)

# 创建颜色映射
cmap = plt.cm.Reds  # 渐变色
norm = mcolors.Normalize(vmin=0, vmax=max(colors) if colors else 1)

# 创建 PatchCollection
pc = PatchCollection(patches, cmap=cmap, norm=norm, edgecolor='black', linewidth=0.5)
pc.set_array(np.array(colors))
ax.add_collection(pc)

# 添加图例
cbar = plt.colorbar(pc, ax=ax)
cbar.set_label("x x x x", fontsize=12)

# 设置地图边界和标题
ax.set_xlim(73, 135)  # 经度范围
ax.set_ylim(18, 54)   # 纬度范围
ax.set_title("xxxxx地理分布（2019年）", fontsize=16)
ax.axis('off')  # 隐藏坐标轴

# 保存为更高分辨率的 JPG 图片
plt.savefig("xxxxx_2019.jpg", dpi=600, quality=95)  # 提高 dpi 和质量
plt.show()
```

# 总结

感谢chatgpt让我花费几个小时画完了我想要的地图。

网上的教程质量不高，基本没用到，有用的信息也很少，关于地图边界文件怎么用也是自己琢磨+chatgpt才明白的。

这个代码的第一个版本是在天津的早上写完的，晚上看演唱会，然后头一天晚上通宵写论文。